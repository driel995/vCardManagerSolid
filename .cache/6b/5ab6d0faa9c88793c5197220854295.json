{"id":"Erc6","dependencies":[{"name":"C:\\Users\\39351\\Progetti\\SolidProject\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\login\\oidc\\refresh\\TokenRefresher.js.map","includedInParent":true,"mtime":1671123281682},{"name":"C:\\Users\\39351\\Progetti\\SolidProject\\node_modules\\@inrupt\\solid-client-authn-browser\\src\\login\\oidc\\refresh\\TokenRefresher.ts","includedInParent":true,"mtime":1671123281752},{"name":"C:\\Users\\39351\\Progetti\\SolidProject\\package.json","includedInParent":true,"mtime":1671127455006},{"name":"C:\\Users\\39351\\Progetti\\SolidProject\\node_modules\\@inrupt\\solid-client-authn-browser\\package.json","includedInParent":true,"mtime":1671123281699},{"name":"@inrupt/solid-client-authn-core","loc":{"line":3,"column":42,"index":121},"parent":"C:\\Users\\39351\\Progetti\\SolidProject\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\login\\oidc\\refresh\\TokenRefresher.js","resolved":"C:\\Users\\39351\\Progetti\\SolidProject\\node_modules\\@inrupt\\solid-client-authn-core\\dist\\index.mjs"},{"name":"@inrupt/oidc-client-ext","loc":{"line":4,"column":34,"index":192},"parent":"C:\\Users\\39351\\Progetti\\SolidProject\\node_modules\\@inrupt\\solid-client-authn-browser\\dist\\login\\oidc\\refresh\\TokenRefresher.js","resolved":"C:\\Users\\39351\\Progetti\\SolidProject\\node_modules\\@inrupt\\oidc-client-ext\\dist\\index.es.js"}],"generated":{"js":"\"use strict\";Object.defineProperty(exports,\"__esModule\",{value:!0});const e=require(\"@inrupt/solid-client-authn-core\"),t=require(\"@inrupt/oidc-client-ext\");class s{constructor(e,t,s){this.storageUtility=e,this.issuerConfigFetcher=t,this.clientRegistrar=s}async refresh(s,r,i,o){const n=await(0,e.loadOidcContextFromStorage)(s,this.storageUtility,this.issuerConfigFetcher),a=await this.clientRegistrar.getClient({sessionId:s},n.issuerConfig);if(void 0===r)throw new Error(`Session [${s}] has no refresh token to allow it to refresh its access token.`);if(n.dpop&&void 0===i)throw new Error(`For session [${s}], the key bound to the DPoP access token must be provided to refresh said access token.`);const c=await(0,t.refresh)(r,n.issuerConfig,a,i);return void 0!==c.refreshToken&&(null==o||o.emit(e.EVENTS.NEW_REFRESH_TOKEN,c.refreshToken),await this.storageUtility.setForUser(s,{refreshToken:c.refreshToken})),c}}exports.default=s;"},"sourceMaps":{"js":{"mappings":[{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":0}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":13}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":20}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":35}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":43}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":56}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":57}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":64}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":27,"column":0},"generated":{"line":1,"column":68}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":27,"column":0},"generated":{"line":1,"column":74}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":27,"column":0},"generated":{"line":1,"column":76}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":27,"column":0},"generated":{"line":1,"column":84}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":38,"column":0},"generated":{"line":1,"column":119}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":38,"column":0},"generated":{"line":1,"column":121}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":38,"column":0},"generated":{"line":1,"column":129}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":156}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":21},"generated":{"line":1,"column":162}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":49,"column":2},"generated":{"line":1,"column":164}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":50,"column":12},"generated":{"line":1,"column":176}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":51,"column":12},"generated":{"line":1,"column":178}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":52,"column":12},"generated":{"line":1,"column":180}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":50,"column":12},"generated":{"line":1,"column":183}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":50,"column":12},"generated":{"line":1,"column":188}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":50,"column":12},"generated":{"line":1,"column":203}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":51,"column":12},"generated":{"line":1,"column":205}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":51,"column":12},"generated":{"line":1,"column":210}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":51,"column":12},"generated":{"line":1,"column":230}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":52,"column":12},"generated":{"line":1,"column":232}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":52,"column":12},"generated":{"line":1,"column":237}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":52,"column":12},"generated":{"line":1,"column":253}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":55,"column":2},"generated":{"line":1,"column":255}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":56,"column":4},"generated":{"line":1,"column":269}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":57,"column":4},"generated":{"line":1,"column":271}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":58,"column":4},"generated":{"line":1,"column":273}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":59,"column":4},"generated":{"line":1,"column":275}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":61,"column":4},"generated":{"line":1,"column":278}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":61,"column":10},"generated":{"line":1,"column":284}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":61,"column":30},"generated":{"line":1,"column":292}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":61,"column":30},"generated":{"line":1,"column":294}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":61,"column":30},"generated":{"line":1,"column":296}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":62,"column":6},"generated":{"line":1,"column":324}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":63,"column":6},"generated":{"line":1,"column":326}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":63,"column":11},"generated":{"line":1,"column":331}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":64,"column":6},"generated":{"line":1,"column":346}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":64,"column":11},"generated":{"line":1,"column":351}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":67,"column":10},"generated":{"line":1,"column":372}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":67,"column":38},"generated":{"line":1,"column":380}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":67,"column":43},"generated":{"line":1,"column":385}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":67,"column":59},"generated":{"line":1,"column":401}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":68,"column":6},"generated":{"line":1,"column":411}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":68,"column":8},"generated":{"line":1,"column":412}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":68,"column":8},"generated":{"line":1,"column":422}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":69,"column":6},"generated":{"line":1,"column":425}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":69,"column":18},"generated":{"line":1,"column":427}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":72,"column":4},"generated":{"line":1,"column":441}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":72,"column":25},"generated":{"line":1,"column":449}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":72,"column":8},"generated":{"line":1,"column":453}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":74,"column":6},"generated":{"line":1,"column":455}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":74,"column":12},"generated":{"line":1,"column":461}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":74,"column":16},"generated":{"line":1,"column":465}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":75,"column":20},"generated":{"line":1,"column":483}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":79,"column":4},"generated":{"line":1,"column":551}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":79,"column":8},"generated":{"line":1,"column":554}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":79,"column":20},"generated":{"line":1,"column":556}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":79,"column":40},"generated":{"line":1,"column":567}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":79,"column":28},"generated":{"line":1,"column":571}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":80,"column":6},"generated":{"line":1,"column":573}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":80,"column":12},"generated":{"line":1,"column":579}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":80,"column":16},"generated":{"line":1,"column":583}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":81,"column":24},"generated":{"line":1,"column":605}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":85,"column":4},"generated":{"line":1,"column":698}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":85,"column":10},"generated":{"line":1,"column":704}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":85,"column":27},"generated":{"line":1,"column":712}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":85,"column":27},"generated":{"line":1,"column":714}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":85,"column":27},"generated":{"line":1,"column":716}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":86,"column":6},"generated":{"line":1,"column":725}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":87,"column":6},"generated":{"line":1,"column":727}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":87,"column":18},"generated":{"line":1,"column":729}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":88,"column":6},"generated":{"line":1,"column":742}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":89,"column":6},"generated":{"line":1,"column":744}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":98,"column":4},"generated":{"line":1,"column":747}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":92,"column":34},"generated":{"line":1,"column":759}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":92,"column":8},"generated":{"line":1,"column":763}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":92,"column":17},"generated":{"line":1,"column":765}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":93,"column":6},"generated":{"line":1,"column":780}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":93,"column":6},"generated":{"line":1,"column":786}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":93,"column":6},"generated":{"line":1,"column":789}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":93,"column":20},"generated":{"line":1,"column":791}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":93,"column":25},"generated":{"line":1,"column":796}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":93,"column":25},"generated":{"line":1,"column":798}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":93,"column":32},"generated":{"line":1,"column":805}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":93,"column":51},"generated":{"line":1,"column":823}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":93,"column":60},"generated":{"line":1,"column":825}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":94,"column":12},"generated":{"line":1,"column":845}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":94,"column":17},"generated":{"line":1,"column":850}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":94,"column":32},"generated":{"line":1,"column":865}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":94,"column":43},"generated":{"line":1,"column":876}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":94,"column":54},"generated":{"line":1,"column":878}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":95,"column":8},"generated":{"line":1,"column":879}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":95,"column":22},"generated":{"line":1,"column":892}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":95,"column":31},"generated":{"line":1,"column":894}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":98,"column":11},"generated":{"line":1,"column":910}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":913}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":921}},{"source":"../../../../src/login/oidc/refresh/TokenRefresher.ts","name":null,"original":{"line":48,"column":0},"generated":{"line":1,"column":929}}],"sources":{"../../../../src/login/oidc/refresh/TokenRefresher.ts":"/*\r\n * Copyright 2022 Inrupt Inc.\r\n *\r\n * Permission is hereby granted, free of charge, to any person obtaining a copy\r\n * of this software and associated documentation files (the \"Software\"), to deal in\r\n * the Software without restriction, including without limitation the rights to use,\r\n * copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the\r\n * Software, and to permit persons to whom the Software is furnished to do so,\r\n * subject to the following conditions:\r\n *\r\n * The above copyright notice and this permission notice shall be included in\r\n * all copies or substantial portions of the Software.\r\n *\r\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,\r\n * INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A\r\n * PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT\r\n * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION\r\n * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\r\n * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n */\r\n\r\n/**\r\n * @hidden\r\n * @packageDocumentation\r\n */\r\n\r\nimport {\r\n  IClient,\r\n  IClientRegistrar,\r\n  IIssuerConfigFetcher,\r\n  IStorageUtility,\r\n  loadOidcContextFromStorage,\r\n  KeyPair,\r\n  ITokenRefresher,\r\n  TokenEndpointResponse,\r\n  EVENTS,\r\n} from \"@inrupt/solid-client-authn-core\";\r\nimport { refresh } from \"@inrupt/oidc-client-ext\";\r\nimport { EventEmitter } from \"events\";\r\n\r\n// Some identifiers are not in camelcase on purpose, as they are named using the\r\n// official names from the OIDC/OAuth2 specifications.\r\n/* eslint-disable camelcase */\r\n\r\n/**\r\n * @hidden\r\n */\r\nexport default class TokenRefresher implements ITokenRefresher {\r\n  constructor(\r\n    private storageUtility: IStorageUtility,\r\n    private issuerConfigFetcher: IIssuerConfigFetcher,\r\n    private clientRegistrar: IClientRegistrar\r\n  ) {}\r\n\r\n  async refresh(\r\n    sessionId: string,\r\n    refreshToken?: string,\r\n    dpopKey?: KeyPair,\r\n    eventEmitter?: EventEmitter\r\n  ): Promise<TokenEndpointResponse> {\r\n    const oidcContext = await loadOidcContextFromStorage(\r\n      sessionId,\r\n      this.storageUtility,\r\n      this.issuerConfigFetcher\r\n    );\r\n    // This should also retrieve the client from storage\r\n    const clientInfo: IClient = await this.clientRegistrar.getClient(\r\n      { sessionId },\r\n      oidcContext.issuerConfig\r\n    );\r\n\r\n    if (refreshToken === undefined) {\r\n      // TODO: in a next PR, look up storage for a refresh token\r\n      throw new Error(\r\n        `Session [${sessionId}] has no refresh token to allow it to refresh its access token.`\r\n      );\r\n    }\r\n\r\n    if (oidcContext.dpop && dpopKey === undefined) {\r\n      throw new Error(\r\n        `For session [${sessionId}], the key bound to the DPoP access token must be provided to refresh said access token.`\r\n      );\r\n    }\r\n\r\n    const tokenSet = await refresh(\r\n      refreshToken,\r\n      oidcContext.issuerConfig,\r\n      clientInfo,\r\n      dpopKey\r\n    );\r\n\r\n    if (tokenSet.refreshToken !== undefined) {\r\n      eventEmitter?.emit(EVENTS.NEW_REFRESH_TOKEN, tokenSet.refreshToken);\r\n      await this.storageUtility.setForUser(sessionId, {\r\n        refreshToken: tokenSet.refreshToken,\r\n      });\r\n    }\r\n    return tokenSet;\r\n  }\r\n}\r\n"},"lineCount":null}},"error":null,"hash":"78a6d9276abaf6a3538d095f5adb8f5e","cacheData":{"env":{}}}